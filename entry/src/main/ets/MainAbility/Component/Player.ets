import { ASMRData } from '../../entity/ASMRData';
import featureAbility from '@ohos.ability.featureAbility'
import dataAbility  from '@ohos.data.dataAbility'
import media from '@ohos.multimedia.media'
import {logInfo} from '../../Util/LogUtil'
import {AsmrCard} from '../Component/AsmrCard'

@Component
export struct Player{
  //åŒå‘ç»‘å®š
  @Link musicList:Array<ASMRData>
  @State @Watch('currentMusicChange') currentMusic:ASMRData = new ASMRData(0,0
    ,'[RJ398341] ã€èƒŒå¾³äº¤å°¾ã€‘ä¸€ç·’ã«ãŠä»•äº‹ã€ã‚µãƒœã‚Šã¾ã›ã‚“ã‹?ï½å„ªç­‰ç”ŸJKã®èª˜æƒ‘ã«è² ã‘ã¦å¿«æ„Ÿã‚’è²ªã‚‹ï½'
    ,'https://cdn.hentaiasmr.moe/asmr4/RJ395660.mp3'
    ,''
    ,'https://www.hentaiasmr.moe/wp-content/uploads/2022/07/rj398341_img_main.jpg'
    ,24000,0,0)
  @State @Watch('watchPlaying') playing:boolean = false
  @State intervalId:number = 0
  @State showList:boolean = false
  //è¿›åº¦æ¡æœ€å¤§å€¼
  @State max:number = 0
  //å½“å‰è¿›åº¦æ¡ä½ç½®
  @State currentTime:number = 0
  @State love:boolean = false
  audioPlayer:media.AudioPlayer = media.createAudioPlayer()

  //å½“å‰éŸ³ä¹å‘ç”Ÿå˜åŒ–æ—¶å›è°ƒ
  currentMusicChange(){
    this.currentTime = 0
    this.playing = false
    //todo æ›´æ–° æ”¶è—ã€è¿›åº¦æ¡æœ€å¤§å€¼çŠ¶æ€
    //æŸ¥è¯¢æ”¶è—æƒ…å†µ
  }
  //ç›‘å¬æ’­æ”¾çŠ¶æ€æ›´æ–°å½“å‰ä½ç½®
  watchPlaying(){
    if(this.playing){
      this.max = this.audioPlayer.duration
      this.intervalId=setInterval(()=>{
        this.currentTime = this.audioPlayer.currentTime
        logInfo(this.audioPlayer.duration+"")
        logInfo(this.audioPlayer.currentTime+"")
      },1000)
    }else{
      clearInterval(this.intervalId)
    }
  }

  //æ”¶è—æˆ–å–æ¶ˆæ”¶è—
  collection(data:ASMRData){
    let uri = 'dataability://com.xjg.player.CollectionDataAbility'
    let valuesBucket= data.valuesBucket()
    let dataHelper = featureAbility.acquireDataAbilityHelper(uri)
    if(this.love){
      //ç§»é™¤æ”¶è—
      let predicates =new dataAbility.DataAbilityPredicates()
      predicates.equalTo('articleId',this.currentMusic.articleId)
      dataHelper.delete(uri, predicates,(error,rows)=>{
        if(rows>0){
          this.love = false
        }
      })
    }else{
      //æ·»åŠ æ”¶è—
      dataHelper.insert(uri,valuesBucket,(error,id)=>{
        if(id>0){
          this.love = true
        }
      })
    }
  }

  nextMusic(){
    this.musicList.push(new ASMRData(0,0
      ,'[RJ382541] ç£ã‚‚è§¦æ‰‹ã‚‚ãŠã£ãã™ã!ã“ã‚“ãªè‹¦ã—ã„ã®ã«ãªã‚“ã§æ°—æŒã¡ã„ã„ã®â€¦ã€CV:ç¯ ãƒäº•å‡›ã€‘'
      ,'https://cdn.hentaiasmr.moe/asmr4/RJ382541.mp3'
      ,''
      ,'https://www.hentaiasmr.moe/wp-content/uploads/2022/06/rj382541_img_main.jpg'
      ,135,0,0))
    console.log('nextMusic')
    let index = this.musicList.indexOf(new ASMRData(0,0
      ,'[RJ398341] ã€èƒŒå¾³äº¤å°¾ã€‘ä¸€ç·’ã«ãŠä»•äº‹ã€ã‚µãƒœã‚Šã¾ã›ã‚“ã‹?ï½å„ªç­‰ç”ŸJKã®èª˜æƒ‘ã«è² ã‘ã¦å¿«æ„Ÿã‚’è²ªã‚‹ï½'
      ,'https://cdn.hentaiasmr.moe/asmr4/RJ395660.mp3'
      ,''
      ,'https://www.hentaiasmr.moe/wp-content/uploads/2022/07/rj398341_img_main.jpg'
      ,24000,0,0))
    console.log("ä½ç½®"+index)
  }

  aboutToAppear(){
    if(this.audioPlayer==null){
      this.audioPlayer = media.createAudioPlayer()
    }
    //åŠ è½½å®Œæˆæ—¶
    this.audioPlayer.on('dataLoad',()=>{
      this.audioPlayer.play()
    })
    this.audioPlayer.on('play',()=>{
      logInfo("æ’­æ”¾")

      this.playing=true
    })
    this.audioPlayer.on('pause',()=>{
      this.playing=false
    })
    this.audioPlayer.on('stop',()=>{
      clearInterval(this.intervalId)
      this.playing=false
      this.audioPlayer.release()
    })
    this.audioPlayer.on('reset',()=>{
      //todo åˆ‡æ¢éŸ³é¢‘
    })
    this.audioPlayer.on('finish',()=>{
      this.playing=false
    })
    this.audioPlayer.on('error',(error)=>{
      logInfo(error.message)
    })


  }

  //todo å¤„ç†æ¨ªå±ä¸‹çš„å¸ƒå±€
  build(){
    Flex({direction:FlexDirection.Column}){
      Flex({justifyContent:FlexAlign.Center,alignItems:ItemAlign.Center,direction:FlexDirection.Column}){
        Image(this.currentMusic.imgUrl)
        .height('800px')
        .width('800px')
        .clip(new Circle({width:'800px', height:'800px'}))
        Row(){
          Slider({step:1000,min:0,max:this.max,value:this.currentTime,style: SliderStyle.InSet})
          .onChange((value,mode) => {
            if(mode==SliderChangeMode.Moving){
              //todo æ»‘åŠ¨ä¸­æ˜¾ç¤ºæ—¶é—´
            }else if(mode==SliderChangeMode.End){
              //todo æ»‘åŠ¨ç»“æŸè°ƒæ•´è¿›åº¦æ¡
            }
          })
        }
        .margin({top:'50px'})
        //æ§åˆ¶æŒ‰é’®
        Row({space: '40px'}){
          Button('<',{stateEffect:this.musicList.length>0})
          if(this.playing){
            Button('||').onClick(()=>{
              this.audioPlayer.stop()
            })
          }else{
            Button(
              'â–·'
//              ,{stateEffect:this.audioPlayer.src.length>0}
            ).onClick(()=>{

              let state = this.audioPlayer.state
              if(state=='playing'){
                //æ’­æ”¾ä¸­
                this.audioPlayer.pause()
                return
              }else if(state == 'idle'){
                //ç©ºé—²
                this.audioPlayer.src = this.currentMusic.musicUrl
              }
              this.audioPlayer.play()
            })
          }

          Button('>',{stateEffect:this.musicList.length>0}).onClick(()=>{this.nextMusic()})
          Button(this.love?'ğŸ¤':'ğŸ–¤').onClick(()=>{
            this.collection(this.currentMusic)
          })
          Button(this.audioPlayer.loop?'â‡†':'â‡‰').onClick(()=>{this.audioPlayer.loop = !this.audioPlayer.loop})

        }
        .justifyContent(FlexAlign.Center)
        .margin({top:'50px'})

      }
      .visibility(this.showList?Visibility.None:Visibility.Visible)
      .width('100%')
      .height('100%')
      //.height(`${this.height-100-400}px`)
      .backgroundColor('red')

      //æ’­æ”¾åˆ—è¡¨
      Flex(){
        //todo æ’­æ”¾åˆ—è¡¨
        if(this.showList){
          Stack({alignContent:Alignment.BottomEnd}){
            Column(){
              Scroll(){
                List({space:5}){
                  ForEach(this.musicList,(music:ASMRData)=>{
                    ListItem(){
                      AsmrCard({
                        data:music
                      })
                    }
                  })
                }
              }
              .onScrollEdge((event) => {
                if(Edge.Bottom==event){
                  console.log("top")
                }
              })
              .scrollBarColor('red')
            }
            .height('100%')

            Button('back')
              .type(ButtonType.Circle).margin({bottom:'50px',right:'50px'})
            .onClick(()=>{
              this.showList = false
            })
          }
          .height('100%')
          .width('100%')
        }else{
          Flex(){
            Flex(){
              Image('https://www.hentaiasmr.moe/wp-content/uploads/2022/07/rj398341_img_main.jpg')
            }
            .width('30%')
            Flex({direction:FlexDirection.Column}){
              Text('[RJ398341] ã€èƒŒå¾³äº¤å°¾ã€‘ä¸€ç·’ã«ãŠä»•äº‹ã€ã‚µãƒœã‚Šã¾ã›ã‚“ã‹?ï½å„ªç­‰ç”ŸJKã®èª˜æƒ‘ã«è² ã‘ã¦å¿«æ„Ÿã‚’è²ªã‚‹ï½')
                .fontSize('24').maxLines(2).textOverflow({overflow: TextOverflow.Ellipsis})
            }
            .width('70%')
          }
        }

      }
      .onClick(()=>{
        this.showList = true
      })
      .height(this.showList?'100%':'200px')
      .width('100%')
    }
    .width('100%')
    .height('100%')
  }
}